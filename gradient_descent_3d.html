<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 梯度下降演示 - Math for AI</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #FDFBF8;
            color: #334155;
        }
        .accent-color { color: #14B8A6; }
        .accent-bg { background-color: #0D9488; }
        .accent-bg-hover:hover { background-color: #0F766E; }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-8 max-w-5xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold accent-color">3D 梯度下降演示</h1>
            <p class="mt-2 text-lg text-slate-600">通过“爬山”过程直观理解梯度下降算法</p>
        </header>
        <main>
            <div class="mb-6 text-center">
                <label class="mr-2 font-semibold">学习率 (Learning Rate, η):</label>
                <input type="range" id="lrSlider" min="0.01" max="0.3" step="0.01" value="0.08" style="width:200px;">
                <span id="lrValue" class="accent-color font-bold">0.08</span>
                <button id="restartBtn" class="ml-6 accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-300">重新开始</button>
            </div>
            <div id="mountainPlot" style="width:100%;height:600px;"></div>
            <div class="mt-6 text-center text-slate-700">
                <b>说明：</b> 该“山”代表一个二元函数 <span style="font-family:Times New Roman,serif;">z = f(x, y)</span>，红点为梯度下降的当前位置，路径为下降轨迹。你可以拖动旋转视角，调整学习率，点击“重新开始”体验不同的下降过程。
            </div>
        </main>
    </div>
    <script>
        // 定义山的函数，这里用 z = (1 - x)^2 + 100*(y - x^2)^2 (Rosenbrock function)
        function f(x, y) {
            return (1 - x) ** 2 + 100 * (y - x ** 2) ** 2;
        }
        // 计算梯度
        function grad(x, y) {
            // ∂f/∂x = -2(1-x) - 400x(y-x^2)
            // ∂f/∂y = 200(y-x^2)
            let dx = -2 * (1 - x) - 400 * x * (y - x ** 2);
            let dy = 200 * (y - x ** 2);
            return [dx, dy];
        }

        // 生成山的网格数据
        let xRange = [];
        let yRange = [];
        for (let i = -2; i <= 2; i += 0.1) xRange.push(i);
        for (let j = -1; j <= 3; j += 0.1) yRange.push(j);
        let zData = [];
        for (let i = 0; i < xRange.length; i++) {
            let row = [];
            for (let j = 0; j < yRange.length; j++) {
                row.push(f(xRange[i], yRange[j]));
            }
            zData.push(row);
        }

        // 梯度下降参数
        let lr = 0.08;
        let path = [];
        let current = {x: -1.5, y: 2.5};
        let step = 0;

        function resetGD() {
            path = [];
            current = {x: -1.5, y: 2.5};
            step = 0;
            path.push([current.x, current.y, f(current.x, current.y)]);
        }

        function doGDStep() {
            let [dx, dy] = grad(current.x, current.y);
            current.x -= lr * dx;
            current.y -= lr * dy;
            path.push([current.x, current.y, f(current.x, current.y)]);
        }

        function plotMountain() {
            // 山体
            let surface = {
                z: zData,
                x: xRange,
                y: yRange,
                type: 'surface',
                colorscale: 'YlGnBu',
                opacity: 0.95,
                showscale: false,
                contours: {
                    z: { show: true, usecolormap: true, highlightcolor: "#42f462", project: { z: true } }
                }
            };
            // 路径
            let pathX = path.map(p => p[0]);
            let pathY = path.map(p => p[1]);
            let pathZ = path.map(p => p[2]);
            let tracePath = {
                x: pathX,
                y: pathY,
                z: pathZ,
                mode: 'lines+markers',
                type: 'scatter3d',
                line: { color: 'red', width: 6 },
                marker: { color: 'red', size: 6 },
                name: '下降轨迹'
            };
            // 当前点
            let tracePoint = {
                x: [pathX[pathX.length-1]],
                y: [pathY[pathY.length-1]],
                z: [pathZ[pathZ.length-1]],
                mode: 'markers',
                type: 'scatter3d',
                marker: { color: 'red', size: 10, symbol: 'circle' },
                name: '当前位置'
            };
            let layout = {
                margin: { l: 0, r: 0, b: 0, t: 0 },
                scene: {
                    xaxis: { title: 'x', range: [-2, 2] },
                    yaxis: { title: 'y', range: [-1, 3] },
                    zaxis: { title: 'z', range: [0, 300] }
                },
                showlegend: false
            };
            Plotly.newPlot('mountainPlot', [surface, tracePath, tracePoint], layout, {responsive: true});
        }

        // 动画
        function animateGD() {
            doGDStep();
            plotMountain();
            step++;
            // 终止条件
            if (step < 60 && path[path.length-1][2] > 1e-3) {
                setTimeout(animateGD, 400);
            }
        }

        // 事件绑定
        document.getElementById('lrSlider').oninput = function() {
            lr = parseFloat(this.value);
            document.getElementById('lrValue').textContent = lr.toFixed(2);
        };
        document.getElementById('restartBtn').onclick = function() {
            resetGD();
            plotMountain();
            step = 0;
            setTimeout(animateGD, 600);
        };

        // 初始化
        resetGD();
        plotMountain();
        setTimeout(animateGD, 800);
    </script>