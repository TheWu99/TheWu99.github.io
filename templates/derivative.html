<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>导数交互式可视化工具 - Math for AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.8.0/lib/browser/math.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #FDFBF8;
            color: #334155;
        }
        .accent-color {
            color: #14B8A6;
        }
        .accent-bg {
            background-color: #0D9488;
        }
        .accent-bg-hover:hover {
            background-color: #0F766E;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-8">
        <header class="flex justify-between items-center mb-12">
            <div class="text-center w-full">
                <h1 class="text-4xl md:text-5xl font-bold accent-color">导数交互式可视化工具</h1>
                <p class="mt-3 text-lg text-slate-600">输入一个函数，选择一个点，直观地理解导数的几何意义。</p>
            </div>
            <div class="ml-4 flex-shrink-0">
                <a href="/" class="inline-block border border-slate-400 text-slate-700 font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-slate-100 transition duration-300">
                    返回首页
                </a>
            </div>
        </header>

        <main>
            <div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
                <form id="derivative-form" class="flex flex-col gap-4">
                    <label>
                        函数 f(x): 
                        <input type="text" id="function-input" value="sin(x)" class="border rounded px-2 py-1 w-full mt-1" />
                    </label>
                    <label>
                        选择点 x₀:
                        <input type="number" id="x0-input" value="1" step="0.1" class="border rounded px-2 py-1 w-full mt-1" />
                    </label>
                    <button type="button" id="plot-btn" class="accent-bg accent-bg-hover text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-300">
                        绘制函数与切线
                    </button>
                </form>
            </div>
            <div id="plot" class="bg-white rounded-lg shadow-md p-4"></div>
            <div id="result" class="mt-6 text-center text-lg accent-color font-semibold"></div>
        </main>
    </div>
    <script>
        function plotFunctionAndTangent() {
            const expr = document.getElementById('function-input').value;
            const x0 = parseFloat(document.getElementById('x0-input').value);

            let f, df;
            try {
                f = math.compile(expr);
                df = math.derivative(expr, 'x').compile();
            } catch (e) {
                document.getElementById('result').innerText = "函数表达式有误，请检查输入。";
                Plotly.purge('plot');
                return;
            }

            // 生成x数据
            const x = [];
            const y = [];
            for (let i = -10; i <= 10; i += 0.05) {
                x.push(i);
                try {
                    y.push(f.evaluate({x: i}));
                } catch {
                    y.push(NaN);
                }
            }

            // 切线
            let slope, y0;
            try {
                slope = df.evaluate({x: x0});
                y0 = f.evaluate({x: x0});
            } catch {
                document.getElementById('result').innerText = "无法计算导数或函数值。";
                Plotly.purge('plot');
                return;
            }

            const tangentY = x.map(xi => slope * (xi - x0) + y0);

            // 绘图
            const data = [
                {
                    x: x,
                    y: y,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'f(x)',
                    line: {color: '#0D9488', width: 3}
                },
                {
                    x: x,
                    y: tangentY,
                    type: 'scatter',
                    mode: 'lines',
                    name: '切线',
                    line: {color: '#F59E42', dash: 'dash', width: 2}
                },
                {
                    x: [x0],
                    y: [y0],
                    type: 'scatter',
                    mode: 'markers',
                    name: '切点',
                    marker: {color: '#EF4444', size: 10}
                }
            ];

            const layout = {
                title: `f(x) 与 x₀=${x0} 处的切线`,
                xaxis: {title: 'x'},
                yaxis: {title: 'y'},
                legend: {x: 0, y: 1.1, orientation: "h"}
            };

            Plotly.newPlot('plot', data, layout, {responsive: true});

            document.getElementById('result').innerHTML =
                `f'(${x0}) = <span class="accent-color">${slope.toFixed(4)}</span>，切点坐标为 (${x0}, ${y0.toFixed(4)})`;
        }

        document.getElementById('plot-btn').onclick = plotFunctionAndTangent;
        window.onload = plotFunctionAndTangent;
    </script>
</body>
</html>